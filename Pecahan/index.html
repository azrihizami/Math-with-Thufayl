<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pecahan, Perpuluhan dan Peratus - Math Learning App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f3e5f5 0%, #e8f5e8 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 2.5em;
            color: #7b1fa2;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        
        .main-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid #f3e5f5;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .experience-bar {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .exp-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }
        
        .exp-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #7b1fa2, #ab47bc);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .category-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .category-select {
            padding: 12px 20px;
            border: 2px solid #7b1fa2;
            border-radius: 8px;
            background: white;
            color: #7b1fa2;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-select:hover {
            background: #7b1fa2;
            color: white;
        }
        
        .progress-section {
            margin-bottom: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7b1fa2, #66bb6a);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .timer-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .timer-fill {
            height: 100%;
            width: 100%;
            transition: all 1s linear;
            background: #66bb6a;
        }
        
        .timer-fill.warning {
            background: #ff9800;
        }
        
        .timer-fill.danger {
            background: #f44336;
            animation: pulse-timer 0.5s infinite alternate;
        }
        
        @keyframes pulse-timer {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
        
        .question-card {
            background: #fafafa;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
            position: relative;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .question-content {
            flex: 1;
        }
        
        .question-text {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
            line-height: 1.6;
        }
        
        .image-container {
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .image-container img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .image-fallback {
            background: #f3e5f5;
            padding: 20px;
            border-radius: 8px;
            color: #7b1fa2;
            font-weight: 500;
        }
        
        .difficulty-badges {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-left: 20px;
        }
        
        .difficulty-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-align: center;
        }
        
        .difficulty-easy { background: #e8f5e9; color: #2e7d32; }
        .difficulty-medium { background: #fff3e0; color: #f57c00; }
        .difficulty-hard { background: #ffebee; color: #c62828; }
        
        .points-badge {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .category-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .option-btn {
            padding: 20px;
            border: 2px solid #7b1fa2;
            border-radius: 12px;
            background: #f8f6ff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1em;
            position: relative;
            transform-origin: center;
        }
        
        .option-btn:hover:not(:disabled) {
            background: #f3e5f5;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(123, 31, 162, 0.15);
        }
        
        .option-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .option-text {
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .option-btn.correct {
            background: #66bb6a;
            color: white;
            border-color: #66bb6a;
            animation: correctPulse 0.6s ease-out;
        }
        
        .option-btn.wrong {
            background: #f44336;
            color: white;
            border-color: #f44336;
            animation: wrongShake 0.5s ease-out;
        }
        
        .option-btn.disabled {
            background: #f0f0f0;
            color: #999;
            border-color: #ddd;
            cursor: not-allowed;
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .feedback {
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid;
            position: relative;
            overflow: hidden;
        }
        
        .feedback::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .feedback.show::before {
            left: 100%;
        }
        
        .feedback.correct {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
            border-color: #66bb6a;
        }
        
        .feedback.wrong {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            border-color: #f44336;
        }
        
        .feedback-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .feedback-icon {
            font-size: 1.5em;
        }
        
        .feedback-explanation {
            font-weight: normal;
            line-height: 1.5;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #7b1fa2, #8e24aa);
            color: white;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(123, 31, 162, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #757575, #616161);
            color: white;
            box-shadow: 0 4px 15px rgba(117, 117, 117, 0.3);
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(117, 117, 117, 0.4);
        }
        
        .btn-back {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            border: 2px solid transparent;
        }
        
        .btn-back:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
            border-color: #495057;
        }
        
        .back-button-container {
            position: absolute;
            top: 20px;
            left: 20px;
        }
        
        .timer-display {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            font-weight: bold;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .timer-display.warning {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
            animation: pulse 2s infinite;
        }
        
        .timer-display.danger {
            background: #f44336;
            color: white;
            border-color: #f44336;
            animation: urgentPulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes urgentPulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-2deg); }
            75% { transform: scale(1.1) rotate(2deg); }
        }
        
        .complete-screen {
            text-align: center;
            padding: 50px 20px;
        }
        
        .trophy-animation {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }
        
        .final-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .final-stat {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .final-stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .final-stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .achievements-section {
            margin-top: 30px;
            text-align: left;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .achievement-badge {
            background: linear-gradient(135deg, #ab47bc, #ce93d8);
            color: #4a148c;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #ab47bc;
            animation: achievementGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes achievementGlow {
            from { box-shadow: 0 4px 15px rgba(171, 71, 188, 0.3); }
            to { box-shadow: 0 8px 25px rgba(171, 71, 188, 0.6); }
        }
        
        .achievement-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }
        
        .achievement-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .achievement-popup {
            position: fixed;
            top: 70px;
            right: 10px;
            background: #ab47bc;
            color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(171, 71, 188, 0.4);
            z-index: 1001;
            animation: slideInBounce 0.6s ease-out;
            border: 2px solid #ce93d8;
            max-width: 250px;
        }
        
        @keyframes slideInBounce {
            0% { transform: translateX(400px); opacity: 0; }
            60% { transform: translateX(-20px); opacity: 1; }
            100% { transform: translateX(0); }
        }
        
        .achievement-popup-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .action-buttons {
            text-align: center;
            margin-top: 20px;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background: #7b1fa2;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .data-table td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
            font-weight: 500;
        }
        
        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .data-table tr:hover {
            background: #f3e5f5;
        }

        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 5px;
        }
        
        .fraction .numerator {
            display: block;
            border-bottom: 2px solid #333;
            padding-bottom: 2px;
        }
        
        .fraction .denominator {
            display: block;
            padding-top: 2px;
        }

        .math-expression {
            font-family: 'Times New Roman', serif;
            font-size: 1.3em;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 5px;
            }
            
            .title {
                font-size: 2em;
            }
            
            .main-stats {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .options {
                grid-template-columns: 1fr;
            }
            
            .timer-display {
                position: fixed;
                top: 5px;
                right: 5px;
                padding: 8px 15px;
                font-size: 1em;
                border-radius: 20px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
            
            .achievement-popup {
                top: 55px;
                right: 5px;
                left: 5px;
                max-width: none;
                padding: 12px;
            }
            
            .difficulty-badges {
                flex-direction: row;
                margin-left: 0;
                margin-top: 15px;
            }
            
            .question-header {
                flex-direction: column;
            }
            
            .final-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            body {
                padding: 10px 5px 5px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="timer-display" id="timerDisplay">‚è∞ 2:00</div>
    
    <div class="back-button-container">
        <button class="btn btn-back" onclick="goBack()">
            ‚Üê Kembali
        </button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">üî¢ Pecahan, Perpuluhan dan Peratus</h1>
            <p class="subtitle">Permainan Matematik Interaktif - Berdasarkan Lembaran Kerja Sebenar</p>
        </div>

        <div class="main-stats">
            <div class="stat-box">
                <div class="stat-number" id="questionCounter" style="color: #7b1fa2;">1/20</div>
                <div class="stat-label">Soalan</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="scoreDisplay" style="color: #66bb6a;">0</div>
                <div class="stat-label">Skor</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="pointsDisplay" style="color: #2e7d32;">0</div>
                <div class="stat-label">Mata</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="streakDisplay" style="color: #ff9800;">0</div>
                <div class="stat-label">Berturut</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="levelDisplay" style="color: #ab47bc;">1</div>
                <div class="stat-label">Tahap</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="timerStat" style="color: #2196f3;">2:00</div>
                <div class="stat-label">Masa</div>
            </div>
        </div>

        <div class="experience-bar">
            <div class="exp-label" id="expLabel">Pengalaman: 0 / 100</div>
            <div class="exp-bar">
                <div class="exp-fill" id="expFill"></div>
            </div>
        </div>

        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">5%</div>
            </div>
            <div class="timer-bar">
                <div class="timer-fill" id="timerBar"></div>
            </div>
        </div>

        <div id="gameArea">
            <div class="question-card">
                <div class="question-header">
                    <div class="question-content">
                        <div class="question-text" id="questionText">
                            Loading question...
                        </div>
                        <div id="imageContainer"></div>
                    </div>
                    <div class="difficulty-badges">
                        <div class="difficulty-badge" id="difficultyBadge">Sederhana</div>
                        <div class="points-badge" id="pointsBadge">20 mata</div>
                        <div class="category-badge" id="categoryBadge">Topik</div>
                    </div>
                </div>
                
                <div class="options" id="optionsContainer">
                    <!-- Options will be populated by JavaScript -->
                </div>

                <div id="feedback" style="display: none;"></div>
                
                <div class="action-buttons" id="actionButtons">
                    <button class="btn btn-secondary" onclick="skipQuestion()">Langkau Soalan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // All 20 questions from the worksheet - with randomized answer positions
        const questions = [
            // Short questions
            {
                id: 1,
                category: 'fraction_conversion',
                difficulty: 'medium',
                question: 'Tukar pecahan tak wajar 29/7 kepada nombor bercampur.',
                answer: '4 1/7',
                options: ['3 8/7', '4 1/7', '3 6/7', '4 2/7'],
                explanation: '29 √∑ 7 = 4 baki 1, jadi jawapannya ialah 4 1/7'
            },
            {
                id: 2,
                category: 'fraction_conversion',
                difficulty: 'medium',
                question: 'Tukar nombor bercampur 5 3/8 kepada pecahan tak wajar.',
                answer: '43/8',
                options: ['42/8', '43/8', '41/8', '44/8'],
                explanation: '(5 √ó 8) + 3 = 40 + 3 = 43/8'
            },
            {
                id: 3,
                category: 'fraction_operations',
                difficulty: 'easy',
                question: 'Kira: 4/9 + 1/9',
                answer: '5/9',
                options: ['5/18', '5/9', '6/9', '4/18'],
                explanation: 'Penyebut sama, jadi tambah pembilang: 4 + 1 = 5, jawapan = 5/9'
            },
            {
                id: 4,
                category: 'fraction_operations',
                difficulty: 'medium',
                question: 'Kira: 3/4 + 5/6',
                answer: '1 7/12',
                options: ['1 5/12', '8/10', '1 7/12', '1 1/2'],
                explanation: 'KPK(4,6) = 12. 3/4 = 9/12, 5/6 = 10/12. 9/12 + 10/12 = 19/12 = 1 7/12'
            },
            {
                id: 5,
                category: 'fraction_operations',
                difficulty: 'easy',
                question: 'Kira: 7/8 - 3/8',
                answer: '1/2',
                options: ['4/16', '10/8', '1/2', '4/0'],
                explanation: 'Penyebut sama, tolak pembilang: 7 - 3 = 4, jawapan = 4/8 = 1/2'
            },
            {
                id: 6,
                category: 'decimal_operations',
                difficulty: 'easy',
                question: 'Kira: 2.48 + 36.7',
                answer: '39.18',
                options: ['39.28', '39.18', '38.18', '39.81'],
                explanation: '2.48 + 36.7 = 39.18'
            },
            {
                id: 7,
                category: 'decimal_operations',
                difficulty: 'medium',
                question: 'Kira: 8 √ó 1.07',
                answer: '8.56',
                options: ['8.46', '8.65', '8.56', '9.56'],
                explanation: '8 √ó 1.07 = 8.56'
            },
            {
                id: 8,
                category: 'decimal_operations',
                difficulty: 'easy',
                question: 'Kira: 100 √ó 5.074',
                answer: '507.4',
                options: ['5074', '507.4', '5.074', '50.74'],
                explanation: 'Apabila darab dengan 100, titik perpuluhan bergerak 2 tempat ke kanan: 507.4'
            },
            {
                id: 9,
                category: 'percentage_conversion',
                difficulty: 'medium',
                question: 'Tukar pecahan 4/5 kepada peratus.',
                answer: '80%',
                options: ['75%', '45%', '80%', '60%'],
                explanation: '4/5 = 4 √∑ 5 = 0.8 = 80%'
            },
            {
                id: 10,
                category: 'percentage_calculations',
                difficulty: 'easy',
                question: 'Hitung 15% daripada 50.',
                answer: '7.5',
                options: ['6.5', '8.5', '9.5', '7.5'],
                explanation: '15% daripada 50 = 15/100 √ó 50 = 7.5'
            },
            
            // Longer word problems with images
            {
                id: 11,
                category: 'word_problems',
                difficulty: 'hard',
                question: 'Setiap hari Pauline menerima wang saku sebanyak RM6 daripada ayahnya. Dia membelanjakan 2/3 daripada wang itu. Baki wangnya disimpan di dalam tabung.',
                subquestions: [
                    'a) Berapakah wang yang telah dibelanjakan setiap hari?',
                    'b) Adakah wang simpanan Pauline melebihi RM8 selepas 5 hari?'
                ],
                image: {
                    src: 'images/pauline-savings.png',
                    alt: 'Pauline menerima wang saku dan menyimpan dalam tabung',
                    description: 'Gambar menunjukkan Pauline menerima wang dari ayah dan memasukkan wang ke dalam tabung simpanan'
                },
                answer: 'RM4, Ya (RM10)',
                options: ['RM3, Tidak', 'RM4, Ya (RM10)', 'RM5, Tidak', 'RM2, Ya (RM20)'],
                explanation: 'a) 2/3 √ó RM6 = RM4 sehari. b) Simpan: 1/3 √ó RM6 = RM2 sehari. 5 hari = RM2 √ó 5 = RM10 > RM8'
            },
            {
                id: 12,
                category: 'word_problems',
                difficulty: 'hard',
                question: 'Gawing ke sekolah setiap hari persekolahan. Gambit cuma tidak hadir ke sekolah pada hari Khamis.',
                subquestions: [
                    'a) Jumlahkan jarak yang dilalui oleh mereka dalam sehari.',
                    'b) Hitung beza jarak yang dilalui oleh Gawing dan Gambit pada minggu itu.'
                ],
                image: {
                    src: 'images/gawing-gambit-route.png',
                    alt: 'Peta jalan dari rumah Gawing dan Gambit ke sekolah',
                    description: 'Peta menunjukkan: Rumah Gawing ke sekolah: 2.2km + 0.52km = 2.72km (sehala). Rumah Gambit ke sekolah: 2.3km + 0.7km + 0.4km = 3.4km (sehala)'
                },
                answer: '12.24 km, 2.72 km',
                options: ['10.5 km, 3.0 km', '11.8 km, 2.5 km', '12.24 km, 2.72 km', '13.6 km, 3.2 km'],
                explanation: 'a) Gawing: 2.72√ó2 = 5.44km, Gambit: 3.4√ó2 = 6.8km. Jumlah = 12.24km. b) Gawing 5 hari: 27.2km, Gambit 4 hari: 27.2km. Beza = 5.44km'
            },
            {
                id: 13,
                category: 'percentage_calculations',
                difficulty: 'hard',
                question: 'Baca pernyataan di bawah:\n‚Ä¢ Kelvin mendapat 48 daripada 60 markah dalam Kuiz Alam Sekitar\n‚Ä¢ Dina mendapat 24 daripada 32 markah dalam Kuiz Keselamatan Jalan Raya\n‚Ä¢ Prem Singh mencatat 81 daripada 90 markah dalam Kuiz Flora dan Fauna\n\nSiapakah yang mendapat peratus markah paling tinggi? Tunjukkan langkah pengiraan.',
                image: {
                    src: 'images/quiz-scores.png',
                    alt: 'Skor kuiz tiga pelajar',
                    description: 'Jadual menunjukkan skor kuiz: Kelvin (48/60), Dina (24/32), Prem Singh (81/90)'
                },
                answer: 'Prem Singh (90%)',
                options: ['Kelvin (80%)', 'Dina (75%)', 'Prem Singh (90%)', 'Semua sama'],
                explanation: 'Kelvin: 48/60 = 80%, Dina: 24/32 = 75%, Prem Singh: 81/90 = 90%. Prem Singh paling tinggi dengan 90%.'
            },
            {
                id: 14,
                category: 'word_problems',
                difficulty: 'hard',
                question: 'Hamimah menggunakan 5 ‚Ñì air mineral, 3/5 ‚Ñì air gula dan 1/10 ‚Ñì pati rozel untuk membuat air rozel. Adakah jumlah isi padu itu melebihi 6 ‚Ñì?',
                image: {
                    src: 'images/hamimah-drink-ingredients.png',
                    alt: 'Bahan-bahan untuk membuat air rozel',
                    description: 'Gambar menunjukkan botol air mineral 5L, bekas air gula, dan botol pati rozel dengan sukatan masing-masing'
                },
                answer: 'Tidak, 5.7 ‚Ñì',
                options: ['Ya, 6.2 ‚Ñì', 'Tidak, 5.7 ‚Ñì', 'Ya, 6.5 ‚Ñì', 'Tidak, 5.5 ‚Ñì'],
                explanation: '5 + 3/5 + 1/10 = 5 + 0.6 + 0.1 = 5.7 ‚Ñì. Tidak melebihi 6 ‚Ñì.'
            },
            {
                id: 15,
                category: 'word_problems',
                difficulty: 'medium',
                question: 'Ayah Fong ada 10 m tali. Dia menggunakan 2.85 m untuk mengikat buku dan 3.12 m untuk mengikat barang terpakai.',
                subquestions: [
                    'i) Berapakah baki panjang tali?',
                    'ii) Hitung beza antara panjang tali untuk mengikat buku dengan barang terpakai.'
                ],
                image: {
                    src: 'images/ayah-fong-rope.png',
                    alt: 'Ayah Fong menggunakan tali untuk mengikat barang',
                    description: 'Gambar menunjukkan gulungan tali 10m dan penggunaannya untuk mengikat buku (2.85m) dan barang terpakai (3.12m)'
                },
                answer: '4.03 m, 0.27 m',
                options: ['4.13 m, 0.37 m', '4.03 m, 0.27 m', '3.93 m, 0.17 m', '4.23 m, 0.47 m'],
                explanation: 'i) 10 - 2.85 - 3.12 = 4.03 m. ii) 3.12 - 2.85 = 0.27 m'
            },
            {
                id: 16,
                category: 'decimal_operations',
                difficulty: 'medium',
                question: 'Lengkapkan silang nombor di bawah. Cari nilai untuk 2.48 + 36.7 (MELINTANG A) dan 31.8 √∑ 10 (MENEGAK A).',
                image: {
                    src: 'images/number-crossword.png',
                    alt: 'Teka silang kata matematik',
                    description: 'Grid silang nombor dengan kotak A yang perlu diisi. MELINTANG A: 2.48 + 36.7, MENEGAK A: 31.8 √∑ 10'
                },
                answer: '39.18, 3.18',
                options: ['38.18, 3.81', '39.18, 3.18', '39.28, 3.28', '40.18, 4.18'],
                explanation: 'MELINTANG A: 2.48 + 36.7 = 39.18, MENEGAK A: 31.8 √∑ 10 = 3.18'
            },
            {
                id: 17,
                category: 'fraction_operations',
                difficulty: 'hard',
                question: 'Tukar nombor bercampur kepada pecahan tak wajar, kemudian kira: 1 2/7 + 3 4/9',
                image: {
                    src: 'images/mixed-number-addition.png',
                    alt: 'Langkah-langkah penukaran nombor bercampur',
                    description: 'Gambar menunjukkan cara menukar 1 2/7 dan 3 4/9 kepada pecahan tak wajar sebelum menambah'
                },
                answer: '4 50/63',
                options: ['4 46/63', '4 50/63', '5 14/63', '4 32/63'],
                explanation: '1 2/7 = 9/7, 3 4/9 = 31/9. KPK(7,9) = 63. 81/63 + 217/63 = 298/63 = 4 50/63'
            },
            {
                id: 18,
                category: 'percentage_calculations',
                difficulty: 'medium',
                question: 'Tentukan peratusan bagi setiap bahagian dalam carta pai yang menunjukkan aktiviti harian pelajar.',
                image: {
                    src: 'images/daily-activities-pie-chart.png',
                    alt: 'Carta pai aktiviti harian pelajar',
                    description: 'Carta pai menunjukkan: Tidur (53/100), Sekolah (15/50), Bermain (24/80)'
                },
                answer: '53%, 30%, 30%',
                options: ['50%, 25%, 35%', '55%, 35%, 25%', '53%, 30%, 30%', '60%, 20%, 40%'],
                explanation: '53/100 = 53%, 15/50 = 30%, 24/80 = 30%'
            },
            {
                id: 19,
                category: 'fraction_operations',
                difficulty: 'hard',
                question: 'Selesaikan persamaan pecahan: Apakah nilai ? dalam 2 1/5 + ? = 3 3/5',
                image: {
                    src: 'images/fraction-equation.png',
                    alt: 'Persamaan pecahan dengan nilai yang hilang',
                    description: 'Gambar menunjukkan persamaan matematik: 2 1/5 + ? = 3 3/5 dengan kotak kosong untuk nilai yang dicari'
                },
                answer: '1 2/5',
                options: ['1 1/5', '1 3/5', '1 2/5', '1 4/5'],
                explanation: '? = 3 3/5 - 2 1/5 = 18/5 - 11/5 = 7/5 = 1 2/5'
            },
            {
                id: 20,
                category: 'word_problems',
                difficulty: 'hard',
                question: 'Rekod masa pertandingan mencari harta karun menunjukkan dua pasukan: Pasukan Ibnu Sina mengambil masa 1 1/6 jam untuk Cabaran A dan 2 1/3 jam untuk Cabaran B. Pasukan Ibnu Khaldun mengambil masa 1 2/3 jam untuk Cabaran A dan 2 4/5 jam untuk Cabaran B. Lengkapkan jadual dan tentukan pasukan yang menang.',
                image: {
                    src: 'images/treasure-hunt-table.png',
                    alt: 'Jadual rekod masa pertandingan',
                    description: 'Jadual menunjukkan masa yang diambil oleh setiap pasukan untuk setiap cabaran dan jumlah masa keseluruhan'
                },
                answer: 'Ibnu Sina (3 1/2 jam)',
                options: ['Ibnu Khaldun (4 7/15 jam)', 'Ibnu Sina (3 1/2 jam)', 'Sama masa', 'Data tidak lengkap'],
                explanation: 'Ibnu Sina: 1 1/6 + 2 1/3 = 7/6 + 7/3 = 21/6 = 3 1/2 jam. Ibnu Khaldun: 1 2/3 + 2 4/5 = 5/3 + 14/5 = 67/15 = 4 7/15 jam. Ibnu Sina menang.'
            }
        ];

        // Achievement definitions
        const achievementDefinitions = [
            { id: 'first_correct', name: 'Permulaan Hebat!', description: 'Jawab soalan pertama dengan betul', icon: 'üåü' },
            { id: 'streak_3', name: 'Dalam Rentak!', description: 'Jawab 3 soalan berturut-turut dengan betul', icon: 'üî•' },
            { id: 'streak_5', name: 'Hebat Sungguh!', description: 'Jawab 5 soalan berturut-turut dengan betul', icon: '‚ö°' },
            { id: 'quick_thinker', name: 'Pemikir Pantas!', description: 'Jawab dalam 10 saat', icon: 'üí®' },
            { id: 'level_2', name: 'Naik Tahap!', description: 'Capai tahap 2', icon: 'üéØ' },
            { id: 'level_3', name: 'Pakar Matematik!', description: 'Capai tahap 3', icon: 'üëë' },
            { id: 'perfect_score', name: 'Sempurna!', description: 'Dapatkan 100% markah', icon: 'üèÜ' },
            { id: 'high_scorer', name: 'Pencapai Tinggi!', description: 'Kumpul 500+ mata', icon: 'üíé' },
            { id: 'fraction_master', name: 'Pakar Pecahan!', description: 'Jawab semua soalan pecahan dengan betul', icon: 'üî¢' },
            { id: 'decimal_expert', name: 'Ahli Perpuluhan!', description: 'Jawab semua soalan perpuluhan dengan betul', icon: 'üìä' },
            { id: 'percentage_pro', name: 'Pro Peratus!', description: 'Jawab semua soalan peratus dengan betul', icon: 'üìà' },
            { id: 'word_problem_solver', name: 'Penyelesai Masalah!', description: 'Jawab semua masalah berayat dengan betul', icon: 'üìù' }
        ];

        // Game state
        let currentQuestion = 0;
        let score = 0;
        let points = 0;
        let streak = 0;
        let bestStreak = 0;
        let level = 1;
        let experience = 0;
        let timeLeft = 30;
        let timerInterval;
        let gameActive = true;
        let unlockedAchievements = [];
        let filteredQuestions = [];
        let categoryStats = {};

        // Shuffle array function for options only
        function shuffleOptions(question) {
            const correctAnswer = question.answer;
            const shuffledOptions = [...question.options];
            
            // Shuffle the options array
            for (let i = shuffledOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
            }
            
            return {
                ...question,
                options: shuffledOptions,
                answer: correctAnswer // Keep the correct answer unchanged
            };
        }

        // Initialize game
        function initGame() {
            console.log('Initializing game...');
            console.log('Questions array length:', questions.length);
            
            // Always use all questions, no filtering
            filteredQuestions = [...questions];
            console.log('Filtered questions length:', filteredQuestions.length);
            
            if (filteredQuestions.length > 0) {
                loadQuestion();
                startTimer();
                updateDisplays();
            } else {
                console.error('No questions available!');
            }
        }

        // Timer functions
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 120; // 2 minutes
            gameActive = true;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('timerDisplay');
            const timerBar = document.getElementById('timerBar');
            const timerStat = document.getElementById('timerStat');
            
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            timerEl.textContent = `‚è∞ ${timeText}`;
            timerStat.textContent = timeText;
            timerBar.style.width = `${(timeLeft / 120) * 100}%`;
            
            if (timeLeft <= 10) {
                timerEl.className = 'timer-display danger';
                timerBar.className = 'timer-fill danger';
                timerStat.style.color = '#f44336';
            } else if (timeLeft <= 30) {
                timerEl.className = 'timer-display warning';
                timerBar.className = 'timer-fill warning';
                timerStat.style.color = '#ff9800';
            } else {
                timerEl.className = 'timer-display';
                timerBar.className = 'timer-fill';
                timerStat.style.color = '#2196f3';
            }
        }

        // Points calculation
        function calculatePoints(difficulty, timeRemaining, isCorrect) {
            if (!isCorrect) return 0;
            
            let basePoints = 0;
            switch (difficulty) {
                case 'easy': basePoints = 10; break;
                case 'medium': basePoints = 20; break;
                case 'hard': basePoints = 30; break;
                default: basePoints = 15;
            }
            
            let timeBonus = timeRemaining > 60 ? 10 : timeRemaining > 30 ? 5 : 0;
            let streakMultiplier = Math.min(streak + 1, 3);
            
            return Math.round((basePoints + timeBonus) * streakMultiplier);
        }

        // Level and experience
        function updateLevel(newPoints) {
            const newExperience = experience + newPoints;
            const newLevel = Math.floor(newExperience / 100) + 1;
            
            if (newLevel > level) {
                checkAchievements('level', newLevel);
                showLevelUp(newLevel);
            }
            
            experience = newExperience;
            level = newLevel;
        }

        function showLevelUp(newLevel) {
            const levelEl = document.getElementById('levelDisplay');
            levelEl.style.animation = 'bounce 1s ease-out';
            setTimeout(() => {
                levelEl.style.animation = '';
            }, 1000);
        }

        // Achievement system
        function checkAchievements(type, value) {
            const newAchievements = [];
            
            switch (type) {
                case 'first_correct':
                    if (score === 0 && !unlockedAchievements.includes('first_correct')) {
                        newAchievements.push('first_correct');
                    }
                    break;
                case 'streak':
                    if (value >= 3 && !unlockedAchievements.includes('streak_3')) newAchievements.push('streak_3');
                    if (value >= 5 && !unlockedAchievements.includes('streak_5')) newAchievements.push('streak_5');
                    break;
                case 'quick_answer':
                    if (timeLeft > 90 && !unlockedAchievements.includes('quick_thinker')) {
                        newAchievements.push('quick_thinker');
                    }
                    break;
                case 'level':
                    if (value >= 2 && !unlockedAchievements.includes('level_2')) newAchievements.push('level_2');
                    if (value >= 3 && !unlockedAchievements.includes('level_3')) newAchievements.push('level_3');
                    break;
                case 'points':
                    if (value >= 500 && !unlockedAchievements.includes('high_scorer')) {
                        newAchievements.push('high_scorer');
                    }
                    break;
                case 'perfect':
                    if (!unlockedAchievements.includes('perfect_score')) {
                        newAchievements.push('perfect_score');
                    }
                    break;
                case 'category_master':
                    checkCategoryMaster(newAchievements);
                    break;
            }
            
            if (newAchievements.length > 0) {
                unlockedAchievements.push(...newAchievements);
                showAchievementPopup(newAchievements[0]);
            }
        }

        function checkCategoryMaster(newAchievements) {
            const fractionQuestions = questions.filter(q => q.category === 'fraction_conversion' || q.category === 'fraction_operations');
            const decimalQuestions = questions.filter(q => q.category === 'decimal_operations');
            const percentageQuestions = questions.filter(q => q.category === 'percentage_conversion' || q.category === 'percentage_calculations');
            const wordProblemQuestions = questions.filter(q => q.category === 'word_problems');
            
            if (!unlockedAchievements.includes('fraction_master') && 
                fractionQuestions.every(q => categoryStats[q.id] === true)) {
                newAchievements.push('fraction_master');
            }
            
            if (!unlockedAchievements.includes('decimal_expert') && 
                decimalQuestions.every(q => categoryStats[q.id] === true)) {
                newAchievements.push('decimal_expert');
            }
            
            if (!unlockedAchievements.includes('percentage_pro') && 
                percentageQuestions.every(q => categoryStats[q.id] === true)) {
                newAchievements.push('percentage_pro');
            }

            if (!unlockedAchievements.includes('word_problem_solver') && 
                wordProblemQuestions.every(q => categoryStats[q.id] === true)) {
                newAchievements.push('word_problem_solver');
            }
        }

        function showAchievementPopup(achievementId) {
            const achievement = achievementDefinitions.find(a => a.id === achievementId);
            if (!achievement) return;

            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-popup-header">
                    <span style="font-size: 2em;">üèÜ</span>
                    <div>
                        <div style="font-weight: bold;">Pencapaian Baru!</div>
                        <div>${achievement.icon} ${achievement.name}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 3000);
        }

        // Question loading
        function loadQuestion() {
            if (currentQuestion >= filteredQuestions.length) {
                showResults();
                return;
            }
            
            // Get question and shuffle its options only
            const originalQ = filteredQuestions[currentQuestion];
            const currentQ = shuffleOptions(originalQ);
            
            // Format question with subquestions if available
            let questionHTML = currentQ.question;
            if (currentQ.subquestions) {
                questionHTML += '<br><br>';
                currentQ.subquestions.forEach(subq => {
                    questionHTML += subq + '<br>';
                });
            }
            
            document.getElementById('questionText').innerHTML = questionHTML;
            
            // Update difficulty and points badges
            const difficultyBadge = document.getElementById('difficultyBadge');
            const pointsBadge = document.getElementById('pointsBadge');
            const categoryBadge = document.getElementById('categoryBadge');
            
            const difficultyText = {
                'easy': 'Mudah',
                'medium': 'Sederhana', 
                'hard': 'Sukar'
            };
            
            const pointsText = {
                'easy': '10',
                'medium': '20',
                'hard': '30'
            };

            const categoryText = {
                'fraction_conversion': 'Penukaran Pecahan',
                'fraction_operations': 'Operasi Pecahan',
                'decimal_operations': 'Operasi Perpuluhan',
                'percentage_conversion': 'Penukaran Peratus',
                'percentage_calculations': 'Pengiraan Peratus',
                'word_problems': 'Masalah Berayat'
            };
            
            difficultyBadge.textContent = difficultyText[currentQ.difficulty] || 'Sederhana';
            difficultyBadge.className = `difficulty-badge difficulty-${currentQ.difficulty || 'medium'}`;
            pointsBadge.textContent = `${pointsText[currentQ.difficulty] || '20'} mata`;
            categoryBadge.textContent = categoryText[currentQ.category] || 'Matematik';
            
            // Store the current question with shuffled options for answer checking
            window.currentQuestionData = currentQ;
            
            // Load image if present
            loadQuestionImage(currentQ);
            
            // Update options (now shuffled)
            loadOptions(currentQ);
            
            // Reset feedback and buttons
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('actionButtons').innerHTML = 
                '<button class="btn btn-secondary" onclick="skipQuestion()">Langkau Soalan</button>';
            
            // Start timer
            startTimer();
            updateDisplays();
        }

        function loadQuestionImage(question) {
            const container = document.getElementById('imageContainer');
            container.innerHTML = '';
            container.style.display = 'none';
            
            if (question.image) {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'image-container';
                
                if (question.image.src) {
                    const img = document.createElement('img');
                    img.src = question.image.src;
                    img.alt = question.image.alt;
                    img.onerror = function() {
                        imageDiv.innerHTML = `<div class="image-fallback">${question.image.description}</div>`;
                    };
                    imageDiv.appendChild(img);
                } else if (question.image.description) {
                    imageDiv.innerHTML = `<div class="image-fallback">${question.image.description}</div>`;
                }
                
                container.appendChild(imageDiv);
                container.style.display = 'block';
            }
        }

        function loadOptions(question) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = `
                    <div class="option-label">Pilihan ${String.fromCharCode(65 + index)}</div>
                    <div class="option-text">${option}</div>
                `;
                btn.dataset.answer = option;
                btn.onclick = () => selectAnswer(option);
                container.appendChild(btn);
            });
        }

        // Answer selection
        function selectAnswer(answer) {
            if (!gameActive) return;
            
            clearInterval(timerInterval);
            gameActive = false;
            
            const currentQ = window.currentQuestionData || filteredQuestions[currentQuestion];
            const isCorrect = answer === currentQ.answer;
            const earnedPoints = calculatePoints(currentQ.difficulty, timeLeft, isCorrect);
            
            // Track category performance using original question id
            const originalQ = filteredQuestions[currentQuestion];
            categoryStats[originalQ.id] = isCorrect;
            
            if (isCorrect) {
                const newScore = score + 1;
                const newStreak = streak + 1;
                const newPoints = points + earnedPoints;
                
                score = newScore;
                streak = newStreak;
                points = newPoints;
                bestStreak = Math.max(bestStreak, newStreak);
                
                updateLevel(earnedPoints);
                
                // Check achievements
                if (newScore === 1) checkAchievements('first_correct');
                checkAchievements('streak', newStreak);
                if (timeLeft > 90) checkAchievements('quick_answer');
                checkAchievements('points', newPoints);
                checkAchievements('category_master');
                
                showFeedback(true, earnedPoints, currentQ.explanation);
            } else {
                streak = 0;
                showFeedback(false, 0, `Jawapan yang betul: ${currentQ.answer}. ${currentQ.explanation}`);
            }
            
            highlightAnswers(answer, isCorrect);
            updateDisplays();
            
            // Check for perfect score
            if (currentQuestion === filteredQuestions.length - 1 && isCorrect && score === filteredQuestions.length) {
                checkAchievements('perfect');
            }
        }

        function skipQuestion() {
            if (!gameActive) return;
            
            clearInterval(timerInterval);
            gameActive = false;
            streak = 0;
            
            const currentQ = window.currentQuestionData || filteredQuestions[currentQuestion];
            const originalQ = filteredQuestions[currentQuestion];
            categoryStats[originalQ.id] = false;
            
            showFeedback(false, 0, `Soalan dilangkau. Jawapan yang betul: ${currentQ.answer}. ${currentQ.explanation}`);
            highlightCorrectAnswer();
            updateDisplays();
        }

        // Feedback display
        function showFeedback(isCorrect, earnedPoints, explanation) {
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.style.display = 'block';
            feedbackEl.className = `feedback ${isCorrect ? 'correct' : 'wrong'} show`;
            
            const icon = isCorrect ? '‚úÖ' : '‚ùå';
            const title = isCorrect ? `Betul! +${earnedPoints} mata!` : 'Tidak betul.';
            const bonus = (isCorrect && timeLeft > 90) ? '<br><span style="color: #ff9800;">‚ö° Bonus Pantas!</span>' : '';
            
            feedbackEl.innerHTML = `
                <div class="feedback-header">
                    <span class="feedback-icon">${icon}</span>
                    <span>${title}${bonus}</span>
                </div>
                <div class="feedback-explanation">${explanation}</div>
            `;
            
            // Update action buttons
            const actionButtons = document.getElementById('actionButtons');
            if (currentQuestion < filteredQuestions.length - 1) {
                actionButtons.innerHTML = '<button class="btn btn-primary" onclick="nextQuestion()">Seterusnya</button>';
            } else {
                actionButtons.innerHTML = '<button class="btn btn-primary" onclick="showResults()">Selesai</button>';
            }
        }

        // Answer highlighting
        function highlightAnswers(selectedAnswer, isCorrect) {
            const options = document.querySelectorAll('.option-btn');
            const currentQ = window.currentQuestionData || filteredQuestions[currentQuestion];
            
            options.forEach((btn, index) => {
                btn.disabled = true;
                const optionText = currentQ.options[index];
                
                if (optionText === currentQ.answer) {
                    btn.className = 'option-btn correct';
                } else if (optionText === selectedAnswer && !isCorrect) {
                    btn.className = 'option-btn wrong';
                } else {
                    btn.className = 'option-btn disabled';
                }
            });
        }

        function highlightCorrectAnswer() {
            const options = document.querySelectorAll('.option-btn');
            const currentQ = window.currentQuestionData || filteredQuestions[currentQuestion];
            
            options.forEach((btn, index) => {
                btn.disabled = true;
                const optionText = currentQ.options[index];
                
                if (optionText === currentQ.answer) {
                    btn.className = 'option-btn correct';
                } else {
                    btn.className = 'option-btn disabled';
                }
            });
        }

        // Navigation
        function nextQuestion() {
            currentQuestion++;
            loadQuestion();
        }

        // Display updates
        function updateDisplays() {
            document.getElementById('questionCounter').textContent = `${currentQuestion + 1}/${filteredQuestions.length}`;
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('pointsDisplay').textContent = points;
            document.getElementById('streakDisplay').textContent = streak;
            document.getElementById('levelDisplay').textContent = level;
            
            const progressPercent = ((currentQuestion + 1) / filteredQuestions.length) * 100;
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${progressPercent}%`;
            progressFill.textContent = `${Math.round(progressPercent)}%`;
            
            const expPercent = ((experience % 100) / 100) * 100;
            const expFill = document.getElementById('expFill');
            expFill.style.width = `${expPercent}%`;
            document.getElementById('expLabel').textContent = `Pengalaman: ${experience} / ${level * 100}`;
        }

        // Results screen
        function showResults() {
            const gameArea = document.getElementById('gameArea');
            const percentage = Math.round((score / filteredQuestions.length) * 100);
            
            let message = '';
            if (percentage === 100) message = 'SEMPURNA! Pakar Pecahan, Perpuluhan dan Peratus! üß†üëë';
            else if (percentage >= 90) message = 'Cemerlang Sekali! üåüüèÜ';
            else if (percentage >= 80) message = 'Cemerlang! üåü';
            else if (percentage >= 70) message = 'Bagus Sekali! üëç‚ú®';
            else if (percentage >= 60) message = 'Bagus! üëç';
            else if (percentage >= 50) message = 'Boleh Tahan! üí™';
            else message = 'Cuba Lagi! Jangan Putus Asa! ü§ó';
            
            let achievementsHTML = '';
            if (unlockedAchievements.length > 0) {
                achievementsHTML = `
                    <div class="achievements-section">
                        <h3>üèÜ Pencapaian</h3>
                        <div class="achievements-grid">
                            ${unlockedAchievements.map(id => {
                                const achievement = achievementDefinitions.find(a => a.id === id);
                                return achievement ? `
                                    <div class="achievement-badge">
                                        <div class="achievement-icon">${achievement.icon}</div>
                                        <div class="achievement-name">${achievement.name}</div>
                                    </div>
                                ` : '';
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            gameArea.innerHTML = `
                <div class="complete-screen">
                    <div class="trophy-animation">üèÜ</div>
                    <h2 style="color: #7b1fa2; margin-bottom: 30px;">Tahniah!</h2>
                    
                    <div class="final-stats">
                        <div class="final-stat">
                            <div class="final-stat-number" style="color: #7b1fa2;">${score}/${filteredQuestions.length}</div>
                            <div class="final-stat-label">Soalan Betul</div>
                        </div>
                        <div class="final-stat">
                            <div class="final-stat-number" style="color: #66bb6a;">${points}</div>
                            <div class="final-stat-label">Mata Dikumpul</div>
                        </div>
                        <div class="final-stat">
                            <div class="final-stat-number" style="color: #ff9800;">${bestStreak}</div>
                            <div class="final-stat-label">Berturut Terbaik</div>
                        </div>
                        <div class="final-stat">
                            <div class="final-stat-number" style="color: #ab47bc;">${level}</div>
                            <div class="final-stat-label">Tahap Dicapai</div>
                        </div>
                    </div>
                    
                    <div style="font-size: 1.2em; margin-bottom: 10px;">Peratusan: ${percentage}%</div>
                    <div style="font-size: 1.8em; color: #66bb6a; margin-bottom: 30px; font-weight: bold;">${message}</div>
                    
                    ${achievementsHTML}
                    
                    <div class="action-buttons" style="margin-top: 40px;">
                        <button class="btn btn-primary" onclick="restartGame()" style="font-size: 1.2em; padding: 15px 30px; margin-right: 15px;">
                            üîÑ Main Lagi
                        </button>
                        <button class="btn btn-back" onclick="goBack()" style="font-size: 1.2em; padding: 15px 30px;">
                            ‚Üê Halaman Utama
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('timerDisplay').style.display = 'none';
        }

        // Game restart
        function restartGame() {
            currentQuestion = 0;
            score = 0;
            points = 0;
            streak = 0;
            level = 1;
            experience = 0;
            unlockedAchievements = [];
            categoryStats = {};
            
            document.getElementById('timerDisplay').style.display = 'block';
            filteredQuestions = [...questions];
            loadQuestion();
        }

        // Navigation functions
        function goBack() {
            window.location.href = '../';
        }

        // Initialize the game
        initGame();
    </script>
</body>
</html>
